<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3GSC - GPU Points (WebGL2)</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background: #0b0b0f;
            color: #eaeaf0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        #app {
            position: fixed;
            inset: 0;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        #label {
            position: absolute;
            top: 16px;
            left: 16px;
            letter-spacing: 0.08em;
            font-weight: 700;
            font-size: 18px;
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(20, 20, 28, 0.6);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            user-select: none;
            z-index: 10;
        }

        #hud {
            position: absolute;
            bottom: 12px;
            left: 16px;
            font-size: 12px;
            opacity: 0.75;
            z-index: 10;
        }

        a {
            color: #9ab4ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="label">3GSC</div>
        <canvas id="gl"></canvas>
        <div id="hud"></div>
    </div>

    <script>
        (function () {
            const canvas = document.getElementById('gl');
            const hud = document.getElementById('hud');
            const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

            // Tweak this to increase/decrease points. Keep reasonable for laptops.
            const NUM_POINTS = 60000;

            /** Setup WebGL2 **/
            /** @type {WebGL2RenderingContext} */
            const gl = canvas.getContext('webgl2', { antialias: false, alpha: false, powerPreference: 'high-performance' });
            if (!gl) {
                document.body.innerHTML = '<p style="padding:16px">WebGL2 not supported in this browser.</p>';
                return;
            }

            function createShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    const info = gl.getShaderInfoLog(shader) || '';
                    gl.deleteShader(shader);
                    throw new Error('Shader compile failed:\n' + info + '\n\n' + source);
                }
                return shader;
            }

            function createProgram(gl, vsSource, fsSource) {
                const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);
                const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    const info = gl.getProgramInfoLog(program) || '';
                    gl.deleteProgram(program);
                    throw new Error('Program link failed:\n' + info);
                }
                gl.deleteShader(vs);
                gl.deleteShader(fs);
                return program;
            }

            const vertexSource = `#version 300 es\n
        precision highp float;\n
        uniform float u_time;\n
        uniform vec2 u_resolution;\n
        out vec3 v_color;\n
        // Hash-based random from gl_VertexID\n
        uint pcg(uint v) {\n
          v = v * 747796405u + 2891336453u;\n
          v ^= v >> 16;\n
          v *= 2246822519u;\n
          v ^= v >> 13;\n
          v *= 3266489917u;\n
          v ^= v >> 16;\n
          return v;\n
        }\n
        float rand(uint seed) {\n
          return float(pcg(seed)) / 4294967295.0;\n
        }\n
        void main() {\n
          uint i = uint(gl_VertexID);\n
          // Scatter pseudo-randomly in clip space [-1, 1]\n
          float x = rand(i * 2u) * 2.0 - 1.0;\n
          float y = rand(i * 2u + 1u) * 2.0 - 1.0;\n
          gl_Position = vec4(x, y, 0.0, 1.0);\n
          // Point size scales with screen height and pulsates slightly with time\n
          float baseSize = 1.6 + 1.2 * sin(float(i) * 0.00007 + u_time * 0.8);\n
          gl_PointSize = baseSize * (u_resolution.y / 900.0);\n
          // Soft hue variation based on index\n
          float hue = fract(float(i) * 0.000013 + u_time * 0.02);\n
          // Approx HSV to RGB (fixed saturation/value)\n
          vec3 k = vec3(1.0, 2.0/3.0, 1.0/3.0);\n
          vec3 p = abs(fract(vec3(hue) + k) * 6.0 - 3.0);\n
          v_color = clamp(p - 1.0, 0.0, 1.0);\n
        }`;

            const fragmentSource = `#version 300 es\n
        precision highp float;\n
        in vec3 v_color;\n
        out vec4 outColor;\n
        void main() {\n
          // Round points with soft edge\n
          vec2 p = gl_PointCoord * 2.0 - 1.0;\n
          float d = dot(p, p);\n
          if (d > 1.0) { discard; }\n
          float alpha = smoothstep(1.0, 0.7, 1.0 - d);\n
          outColor = vec4(v_color * 0.9 + 0.1, alpha);\n
        }`;

            const program = createProgram(gl, vertexSource, fragmentSource);
            const uniforms = {
                time: gl.getUniformLocation(program, 'u_time'),
                resolution: gl.getUniformLocation(program, 'u_resolution'),
            };

            // WebGL2 requires a VAO bound even if we use gl_VertexID procedurally
            const vao = gl.createVertexArray();
            gl.bindVertexArray(vao);

            gl.clearColor(0.05, 0.05, 0.08, 1.0);
            gl.enable(gl.BLEND);
            gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

            function resize() {
                const w = Math.max(1, Math.floor(canvas.clientWidth * dpr));
                const h = Math.max(1, Math.floor(canvas.clientHeight * dpr));
                if (canvas.width !== w || canvas.height !== h) {
                    canvas.width = w;
                    canvas.height = h;
                }
                gl.viewport(0, 0, canvas.width, canvas.height);
            }

            function fitToWindow() {
                // Ensure CSS size matches the window
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                resize();
            }

            window.addEventListener('resize', () => {
                fitToWindow();
            });

            fitToWindow();

            let start = performance.now();
            function frame(now) {
                const t = (now - start) / 1000;
                resize();

                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.useProgram(program);
                gl.uniform1f(uniforms.time, t);
                gl.uniform2f(uniforms.resolution, canvas.width, canvas.height);
                gl.bindVertexArray(vao);
                gl.drawArrays(gl.POINTS, 0, NUM_POINTS);

                // HUD
                hud.textContent = `Points: ${NUM_POINTS.toLocaleString()}  |  ` +
                    `Canvas: ${canvas.width}Ã—${canvas.height}  |  ` +
                    `FPS~ (browser)`;

                requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        })();
    </script>
</body>

</html>